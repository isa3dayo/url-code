<!--
概要:
GitHub Pages に配置する「待機画面 → 時間帯判定 → 許可リスト検証 → (任意)稼働チェック → 自動遷移」ページの完成版。

要件実装:
- url_input が "setting" の場合は準備中メッセージ表示
- url_input は悪用対策として、以下のみ許可:
    1) LIFF: https://liff.line.me/{liff_id}...（liff_id は許可リスト配列）
    2) GAS : https://script.google.com/macros/s/{gas_id}...（gas_id は許可リスト配列）
- LIFF は許可されたIDならそのまま遷移
- GAS は許可されたIDなら「POSTでアクセス → 返ってきたURLへ遷移」
    ※ GASから返るURLはドメイン制限しない（要件どおり）
- health_url は任意:
    - 未指定/空なら稼働チェックしない
    - 指定がある場合だけ Image ping で稼働チェック（CORS不要）
      ※ 稼働チェック対象は「遷移前のURL（LIFF or GAS）」に対して行う
- JST 7:00〜22:00 の間だけ遷移処理を行い、それ以外は運用時間外メッセージ
- url_input / health_url / page_name は encodeURIComponent 済み推奨（未encodeでも壊れにくく処理）

導入しているもの:
- クエリ解析 (URLSearchParams)
- 安全なデコード
- JST固定の時間判定
- CORS不要の稼働チェック(Image ping + timeout)
- GAS POST(fetch) → 返却URLへ遷移
- 許可IDリストによる悪用抑止
-->

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="cache-control" content="no-store" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Redirecting...</title>

  <!-- =========================
       UI / スタイル
  ========================== -->
  <style>
    :root {
      --bg: #0b1220;
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --accent: #66d9ff;
      --danger: #ff6b6b;
      --warn: #ffd166;
      --ok: #7bed9f;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(102,217,255,.18), transparent 60%),
        radial-gradient(1000px 700px at 80% 90%, rgba(255,107,107,.12), transparent 60%),
        var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .card {
      width: min(600px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .title {
      font-size: 18px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 10px;
      line-height: 1.2;
    }
    .badge {
      font-size: 12px;
      font-weight: 800;
      color: rgba(0,0,0,.85);
      background: var(--accent);
      padding: 3px 9px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .desc {
      margin: 0 0 12px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 14px;
      white-space: pre-line;
    }
    .spinner {
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 4px solid rgba(255,255,255,.18);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
      margin: 10px auto 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      min-height: 18px;
    }

    .message {
      border-left: 4px solid var(--danger);
      padding-left: 10px;
      margin-top: 10px;
      color: rgba(255,255,255,.9);
      line-height: 1.6;
      font-size: 14px;
      white-space: pre-line;
    }
    .message.warn { border-left-color: var(--warn); }
    .message.ok { border-left-color: var(--ok); }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:hover { background: rgba(255,255,255,.14); }
    .btn.primary {
      border-color: rgba(102,217,255,.35);
      background: rgba(102,217,255,.18);
    }
    .small {
      margin-top: 12px;
      font-size: 12px;
      color: rgba(255,255,255,.45);
      line-height: 1.5;
      word-break: break-all;
      white-space: pre-line;
    }
    .hidden { display: none; }
  </style>
</head>

<body>
  <main class="card" role="main" aria-live="polite">
    <h1 class="title">
      <span id="pageTitle">接続中…</span>
      <span class="badge" id="badge">WAIT</span>
    </h1>

    <p class="desc" id="desc">遷移先を確認しています。\nしばらくお待ちください…</p>

    <div class="spinner" id="spinner" aria-hidden="true"></div>
    <div class="status" id="status">確認中</div>

    <div class="message hidden" id="messageBox"></div>

    <div class="actions hidden" id="actions">
      <button class="btn primary" id="retryBtn" type="button">再試行</button>
      <a class="btn" id="openTargetLink" href="#" rel="noopener noreferrer">遷移先を開く</a>
    </div>

    <div class="small" id="debug"></div>
  </main>

  <!-- =========================
       設定（運用で編集しやすい場所）
  ========================== -->
  <script>
    // 運用時間（JST 기준）
    const OPEN_HOUR = 7;   // 7:00 から
    const CLOSE_HOUR = 22; // 22:00 まで（22:00台はOK / 23:00からNG）

    // 稼働チェック用タイムアウト(ms)
    const DEFAULT_PING_TIMEOUT_MS = 4500;

    // GAS POSTのタイムアウト(ms)
    const DEFAULT_GAS_POST_TIMEOUT_MS = 6500;

    // ▼ 許可する GAS の ID リスト（ここを編集するだけで運用変更できる）
    // 例: https://script.google.com/macros/s/{gas_id}/exec
    const GAS_ID_ALLOWLIST = [
      "AKfycbzeVQwcz7O2DbYq",
      "YOUR_GAS_ID_2",
    ];

    // ▼ 許可する LIFF の ID リスト（ここを編集するだけで運用変更できる）
    // 例: https://liff.line.me/{liff_id}
    const LIFF_ID_ALLOWLIST = [
      "200902807",
      "YOUR_LIFF_ID_2",
    ];

    // true にすると画面下部にデバッグ表示を出す
    const DEBUG = false;
  </script>

  <!-- =========================
       ロジック本体
  ========================== -->
  <script>
    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    function safeDecodeURIComponent(maybeEncoded) {
      if (maybeEncoded == null) return "";
      const s = String(maybeEncoded).trim();
      if (!s) return "";
      try {
        if (/%[0-9A-Fa-f]{2}/.test(s)) return decodeURIComponent(s);
        return s;
      } catch {
        return s;
      }
    }

    function getQueryParams() {
      const u = new URL(location.href);
      return {
        urlInput: safeDecodeURIComponent(u.searchParams.get("url_input")),
        healthUrl: safeDecodeURIComponent(u.searchParams.get("health_url")),
        pageName: safeDecodeURIComponent(u.searchParams.get("page_name")),
      };
    }

    function getJstNow() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 9 * 60 * 60000);
    }

    function isInOperatingHoursJst(date) {
      const h = date.getHours();
      return h >= OPEN_HOUR && h <= CLOSE_HOUR; // 7〜22
    }

    function isHttpUrl(url) {
      try {
        const u = new URL(url);
        return u.protocol === "http:" || u.protocol === "https:";
      } catch {
        return false;
      }
    }

    function setWaiting(pageName) {
      $("pageTitle").textContent = pageName ? `${pageName}へ移動中…` : "移動中…";
      $("badge").textContent = "WAIT";
      $("badge").style.background = "var(--accent)";
      $("desc").textContent = "遷移先を確認しています。\nしばらくお待ちください…";
      $("spinner").classList.remove("hidden");
      $("status").textContent = "確認中";
      $("messageBox").classList.add("hidden");
      $("actions").classList.add("hidden");
    }

    function setMessage({ badge, badgeColor, title, desc, message, messageClass }) {
      if (title) $("pageTitle").textContent = title;
      if (desc != null) $("desc").textContent = desc;

      $("badge").textContent = badge || "INFO";
      $("badge").style.background = badgeColor || "var(--accent)";

      $("spinner").classList.add("hidden");
      $("status").textContent = "";

      $("messageBox").classList.remove("hidden");
      $("messageBox").className = `message ${messageClass || ""}`.trim();
      $("messageBox").innerHTML = escapeHtml(message).replace(/\n/g, "<br/>");
    }

    function showActions(targetUrl, onRetry) {
      $("actions").classList.remove("hidden");
      $("retryBtn").onclick = onRetry;

      if (targetUrl && isHttpUrl(targetUrl)) {
        $("openTargetLink").href = targetUrl;
        $("openTargetLink").classList.remove("hidden");
      } else {
        $("openTargetLink").href = "#";
        $("openTargetLink").classList.add("hidden");
      }
    }

    function setOutOfHours(pageName) {
      const name = pageName || "対象ページ";
      setMessage({
        badge: "CLOSED",
        badgeColor: "var(--warn)",
        title: name,
        desc: "",
        message:
          `現在${name}が運用時間外のため、稼働していません。\n` +
          `${OPEN_HOUR}:00〜${CLOSE_HOUR}:00に再度ページを開き直してください`,
        messageClass: "warn"
      });
    }

    function setDown(pageName) {
      const name = pageName || "対象ページ";
      setMessage({
        badge: "DOWN",
        badgeColor: "var(--danger)",
        title: name,
        desc: "",
        message: `現在${name}が稼働していません`,
        messageClass: ""
      });
    }

    function setPreparing(pageName) {
      const name = pageName || "対象";
      setMessage({
        badge: "PREPARING",
        badgeColor: "var(--warn)",
        title: name,
        desc: "",
        message: `現在「${name}」のページは準備中です。\n実装までお待ちください。`,
        messageClass: "warn"
      });
    }

    function setBadRequest(msg) {
      setMessage({
        badge: "ERROR",
        badgeColor: "var(--danger)",
        title: "エラー",
        desc: "",
        message: msg,
        messageClass: ""
      });
    }

    function redirectTo(url) {
      $("badge").textContent = "GO";
      $("badge").style.background = "var(--ok)";
      $("status").textContent = "遷移します…";
      location.replace(url);
    }

    /**
     * Image ping（CORS不要）
     */
    function pingByImage(url, timeoutMs) {
      return new Promise((resolve) => {
        const img = new Image();
        let settled = false;

        const timer = setTimeout(() => {
          if (settled) return;
          settled = true;
          cleanup();
          resolve(false);
        }, timeoutMs);

        function cleanup() {
          clearTimeout(timer);
          img.onload = null;
          img.onerror = null;
        }

        img.onload = () => {
          if (settled) return;
          settled = true;
          cleanup();
          resolve(true);
        };
        img.onerror = () => {
          if (settled) return;
          settled = true;
          cleanup();
          resolve(false);
        };

        const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
        img.src = url + bust;
      });
    }

    /**
     * GASへPOSTして、返ってきたURL（文字列 or JSON）を取り出す
     * - content-type を text/plain にしてプリフライトを避けやすくする（環境によりCORSが必要）
     * - GAS側は doPost で URL を返す（例: JSON { "redirectUrl": "..." } か、プレーンテキストURL）
     */
    async function postToGasAndGetRedirectUrl(gasUrl, payload, timeoutMs) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const res = await fetch(gasUrl, {
          method: "POST",
          mode: "cors",
          cache: "no-store",
          signal: controller.signal,
          headers: {
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify(payload ?? {})
        });

        // CORSやGAS設定によりここで例外/失敗になることがある
        if (!res.ok) throw new Error("GAS HTTP status not ok");

        const text = await res.text();

        // 1) JSON形式を試す
        try {
          const obj = JSON.parse(text);
          const u = obj.redirectUrl || obj.url || obj.targetUrl || "";
          return String(u || "").trim();
        } catch {
          // 2) プレーンテキストURLとして扱う
          return String(text || "").trim();
        }
      } finally {
        clearTimeout(timer);
      }
    }


// =========================
// 許可判定ロジック（部分ID=prefix対応版）
// =========================

function matchesAnyPrefix(value, prefixList) {
  if (!value) return false;
  return prefixList.some((p) => {
    const prefix = String(p || "").trim();
    if (!prefix) return false;
    return value.startsWith(prefix);
  });
}

function isAllowedLiffUrl(targetUrl) {
  // 許可: https://liff.line.me/{liff_id}... で、{liff_id} が許可prefixに一致
  if (!isHttpUrl(targetUrl)) return false;

  const prefix = "https://liff.line.me/";
  if (!targetUrl.startsWith(prefix)) return false;

  const rest = targetUrl.slice(prefix.length);
  const id = rest.split(/[\/?#]/)[0] || ""; // {liff_id} を取り出す

  // 完全一致ではなく prefix一致
  return matchesAnyPrefix(id, LIFF_ID_ALLOWLIST);
}

function isAllowedGasUrl(targetUrl) {
  // 許可: https://script.google.com/macros/s/{gas_id}... で、{gas_id} が許可prefixに一致
  if (!isHttpUrl(targetUrl)) return false;

  const base = "https://script.google.com/macros/s/";
  if (!targetUrl.startsWith(base)) return false;

  const rest = targetUrl.slice(base.length);
  const id = rest.split(/[\/?#]/)[0] || ""; // {gas_id} を取り出す

  // 完全一致ではなく prefix一致
  return matchesAnyPrefix(id, GAS_ID_ALLOWLIST);
}


    // =========================
    // メイン
    // =========================

    async function run() {
      const { urlInput, healthUrl, pageName } = getQueryParams();
      setWaiting(pageName);

      const nowJst = getJstNow();
      if (DEBUG) {
        $("debug").textContent =
          `JST=${nowJst.toISOString().replace("T", " ").slice(0, 19)}\n` +
          `url_input=${urlInput || "(none)"}\n` +
          `health_url=${healthUrl || "(none)"}\n` +
          `page_name=${pageName || "(none)"}\n` +
          `allowedGAS=${GAS_ID_ALLOWLIST.length}, allowedLIFF=${LIFF_ID_ALLOWLIST.length}`;
      } else {
        $("debug").textContent = "";
      }

      // 特例: setting
      if (urlInput === "setting") {
        setPreparing(pageName);
        return;
      }

      // 時間外
      if (!isInOperatingHoursJst(nowJst)) {
        setOutOfHours(pageName);
        showActions("", () => run());
        return;
      }

      // url_input 必須
      if (!urlInput) {
        setBadRequest("URLパラメータ url_input が指定されていません。");
        return;
      }

      // health_url がある場合のみ稼働チェック（ただしチェック対象は「遷移前のURL」）
      // 例: LIFFに飛ぶ前にLIFFのfaviconをチェック、GASならGASの /exec をチェックなど
      if (healthUrl) {
        if (!isHttpUrl(healthUrl)) {
          setBadRequest("health_url を指定する場合は http(s) のURLのみ許可しています。");
          return;
        }
        $("status").textContent = "稼働状況を確認しています…";
        const ok = await pingByImage(healthUrl, DEFAULT_PING_TIMEOUT_MS);
        if (!ok) {
          setDown(pageName);
          showActions("", () => run());
          return;
        }
      }

      // 1) LIFF許可ならそのまま遷移
      if (isAllowedLiffUrl(urlInput)) {
        redirectTo(urlInput);
        return;
      }

      // 2) GAS許可なら POST → 返却URLへ遷移（返却URLはドメイン制限しない）
      if (isAllowedGasUrl(urlInput)) {
        $("status").textContent = "GASへ問い合わせています…";

        try {
          // GASへ渡す payload（必要ならここに追加）
          const payload = {
            page_name: pageName || "",
            // 必要なら、クエリごと渡す等も可能
            // from: location.href
          };

          const redirectUrl = await postToGasAndGetRedirectUrl(
            urlInput,
            payload,
            DEFAULT_GAS_POST_TIMEOUT_MS
          );

          if (!redirectUrl) {
            setDown(pageName);
            showActions("", () => run());
            return;
          }

          // 返却URLはドメイン制限しないが、最低限 http(s) だけ許可（危険スキーム対策）
          if (!isHttpUrl(redirectUrl)) {
            setBadRequest("GASから返却されたURLが http(s) ではありません。");
            return;
          }

          redirectTo(redirectUrl);
          return;
        } catch (e) {
          // CORS / タイムアウト / GASダウンなど
          setDown(pageName);
          showActions("", () => run());
          return;
        }
      }

      // それ以外は拒否
      setBadRequest(
        "許可されていない遷移先です。\n" +
        "このページは LIFF / GAS の許可IDのみ遷移できます。"
      );
    }

    run();
  </script>
</body>
</html>

